---
- name: "Initial hosts configurations"
  hosts: all
  become: yes
  gather_facts: true

  tasks:

  - name: "Disable selinux"
    selinux:
      state: disabled
    register: selinux

  - name: "Reboot the server if selinux has been changed"
    reboot:
    when: selinux.changed

  - name: "Setup /etc/hosts"
    blockinfile:
      path: /etc/hosts
      marker: "<!-- {mark} ANSIBLE MANAGED BLOCK -->"
      block: |
        10.0.0.10 lb lb.k8s.local
        10.0.0.20 master1 master1.k8s.local
        10.0.0.21 master2 master2.k8s.local
        10.0.0.22 master3 master3.k8s.local
        10.0.0.30 worker1 worker1.k8s.local
        10.0.0.31 worker2 worker2.k8s.local

  - name: "Set authorized key for user Vagrant"
    authorized_key:
      user: vagrant
      state: present
      key: "{{ lookup('file', '../../key.pub') }}"

  - name: "Create directory under /run/systemd/resolve"
    file:
      path: /run/systemd/resolve
      state: directory

  - name: "Set symlink to /etc/resolv.conf"
    file:
      src: /etc/resolv.conf
      dest: /run/systemd/resolve/resolv.conf
      state: link

  - name: "Disable SWAP since kubernetes can't work with swap enabled (1/2)"
    shell: |
      swapoff -a
  
  - name: "Disable SWAP in fstab since kubernetes can't work with swap enabled (2/2)"
    replace:
      path: /etc/fstab
      regexp: '^(.+?\sswap\s+sw\s+.*)$'
      replace: '# \1'

  - name: "Enable Bridge-netfilter to allow cni communication"
    sysctl:
      name: net.bridge.bridge-nf-call-iptables
      state: present
      value: 1
      reload: yes
